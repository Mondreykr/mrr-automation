<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF PN Extraction Test</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 40px auto;
            padding: 20px;
        }
        #dropzone {
            border: 2px dashed #ccc;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            background: #f9f9f9;
        }
        #dropzone.dragover {
            border-color: #4CAF50;
            background: #e8f5e9;
        }
        #results {
            margin-top: 20px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background: #4CAF50;
            color: white;
        }
        tr:nth-child(even) {
            background: #f2f2f2;
        }
        #rawText {
            margin-top: 20px;
            padding: 10px;
            background: #f5f5f5;
            border: 1px solid #ddd;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
        }
        .section {
            margin-top: 30px;
        }
        h3 {
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 5px;
        }
    </style>
</head>
<body>
    <h1>PDF Part Number Extraction Test</h1>
    <p>Drop a PO PDF here or click to select. This will attempt to extract Part Numbers.</p>

    <div id="dropzone">
        <input type="file" id="fileInput" accept=".pdf" style="display:none">
        <p>Drop PDF here or click to browse</p>
    </div>

    <div id="results"></div>

    <div class="section">
        <h3>Extracted Part Numbers</h3>
        <div id="pnTable"></div>
    </div>

    <div class="section">
        <h3>Raw Extracted Text (for debugging)</h3>
        <div id="rawText"></div>
    </div>

    <script>
        // Set worker path for pdf.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        const dropzone = document.getElementById('dropzone');
        const fileInput = document.getElementById('fileInput');
        const results = document.getElementById('results');
        const pnTable = document.getElementById('pnTable');
        const rawText = document.getElementById('rawText');

        // Click to browse
        dropzone.addEventListener('click', () => fileInput.click());

        // Drag and drop handlers
        dropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropzone.classList.add('dragover');
        });

        dropzone.addEventListener('dragleave', () => {
            dropzone.classList.remove('dragover');
        });

        dropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropzone.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file && file.type === 'application/pdf') {
                processPDF(file);
            }
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                processPDF(file);
            }
        });

        async function processPDF(file) {
            results.innerHTML = '<p>Processing PDF...</p>';

            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

                let allText = '';
                const extractedPNs = [];

                // Extract text from each page
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    allText += `\n--- PAGE ${i} ---\n${pageText}`;

                    // Look for Part Number patterns
                    // Pattern 1: "1234567 |" (7 digits followed by pipe)
                    const pnPattern = /(\d{7})\s*\|/g;
                    let match;
                    while ((match = pnPattern.exec(pageText)) !== null) {
                        if (!extractedPNs.includes(match[1])) {
                            extractedPNs.push(match[1]);
                        }
                    }

                    // Pattern 2: Look for 7-digit numbers that appear in item context
                    // This catches cases where formatting might differ
                    const altPattern = /\b(\d{7})\b/g;
                    while ((match = altPattern.exec(pageText)) !== null) {
                        // Filter: only include if it looks like a PN (starts with 10)
                        if (match[1].startsWith('10') && !extractedPNs.includes(match[1])) {
                            extractedPNs.push(match[1]);
                        }
                    }
                }

                // Display results
                results.innerHTML = `<p><strong>File:</strong> ${file.name}</p>
                                     <p><strong>Pages:</strong> ${pdf.numPages}</p>
                                     <p><strong>Part Numbers Found:</strong> ${extractedPNs.length}</p>`;

                // Display PN table
                if (extractedPNs.length > 0) {
                    let tableHTML = '<table><tr><th>#</th><th>Part Number</th></tr>';
                    extractedPNs.forEach((pn, idx) => {
                        tableHTML += `<tr><td>${idx + 1}</td><td>${pn}</td></tr>`;
                    });
                    tableHTML += '</table>';
                    pnTable.innerHTML = tableHTML;
                } else {
                    pnTable.innerHTML = '<p style="color:red;">No part numbers found. Check raw text below.</p>';
                }

                // Display raw text for debugging
                rawText.textContent = allText;

            } catch (error) {
                results.innerHTML = `<p style="color:red;">Error: ${error.message}</p>`;
                console.error(error);
            }
        }
    </script>
</body>
</html>
